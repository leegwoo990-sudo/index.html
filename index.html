<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>카카오맵 반경 + 검색 + 다각형 (최종 통합본)</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
html, body { width:100%; height:100%; margin:0; }
#map { width:100%; height:100%; }

.control-box{
  position:absolute; top:10px; left:10px; z-index:10;
  background:#fff; padding:10px; border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.3); font-size:12px;
}
.control-box input{ width:140px; margin-bottom:4px; }
.control-box button{ width:150px; margin-top:4px; }

.radius-ui{
  background:#fff; border:1px solid #ccc; border-radius:4px;
  padding:4px 8px; font-size:11px; white-space:nowrap;
  cursor:move; user-select:none;
}
.radius-ui button{
  border:none; background:none; cursor:pointer;
  font-size:11px; color:#ff3b3b; margin-left:4px;
}
.info{
  background:#fff; border:1px solid #333;
  border-radius:4px; padding:4px 8px;
  font-size:11px; white-space:nowrap;
}
</style>
</head>

<body class="bg-slate-900">
<div id="map"></div>

<div class="control-box">
  <input type="text" id="keyword" placeholder="장소 검색">
  <button onclick="searchPlace()">검색</button>
  <hr>

  <input type="number" id="radiusInput" placeholder="반경 m 입력">
  <button onclick="enableClickRadius()" id="clickRadiusBtn">반경 생성</button>
  <hr>

  <button onclick="toggleDraw()" id="drawBtn">반경 그리기 OFF</button>
  <button onclick="removeCircles()">반경 모두 삭제</button>
  <hr>

  <button id="polyToggleBtn" onclick="togglePolygonMode()">다각형 모드 OFF</button>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac34ac36d4448af73f238be750e1e0e7&libraries=services"></script>
<script>
/* ================= 지도 ================= */
const map = new kakao.maps.Map(document.getElementById('map'), {
  center:new kakao.maps.LatLng(33.450422139819736,126.5709139924533),
  level:3
});
map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);

/* ================= 검색 ================= */
const ps = new kakao.maps.services.Places();
let searchMarkers=[];
function searchPlace(){
  const keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert('검색어 입력');
  searchMarkers.forEach(m=>m.setMap(null));
  searchMarkers=[];
  ps.keywordSearch(keyword,(data,status)=>{
    if(status!==kakao.maps.services.Status.OK) return;
    const bounds=new kakao.maps.LatLngBounds();
    data.forEach(p=>{
      const pos=new kakao.maps.LatLng(p.y,p.x);
      bounds.extend(pos);
      searchMarkers.push(new kakao.maps.Marker({map,position:pos}));
    });
    map.setBounds(bounds);
  });
}

/* ================= 반경 ================= */
let circles=[], circleIdCounter=0;
let clickRadiusMode=false, drawEnabled=false;
let drawingFlag=false, centerPosition, drawingLine, drawingCircle;

function enableClickRadius(){
  const r=parseInt(radiusInput.value);
  if(!r||r<=0) return alert('반경 입력');
  clickRadiusMode=true;
  clickRadiusBtn.innerText='지도 클릭 대기중...';
}

function toggleDraw(){
  drawEnabled=!drawEnabled;
  if(drawEnabled && polygonModeEnabled) togglePolygonMode(false);
  drawBtn.innerText=drawEnabled?'반경 그리기 ON':'반경 그리기 OFF';
}

function createCircle(center,r,id){
  const cid=(id!==undefined)?id:circleIdCounter++;
  const circle=new kakao.maps.Circle({
    map, center, radius:r,
    strokeWeight:3, strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b', fillOpacity:.25
  });

  const box=document.createElement('div');
  box.className='radius-ui';
  box.innerHTML=`${Math.round(r)}m <button>✕</button>`;

  const overlay=new kakao.maps.CustomOverlay({
    map, position:center, content:box, yAnchor:1
  });

  enableCircleDrag(circle,overlay,cid,box);
  circles.push({id:cid,circle,overlay});
  saveState();
}

function enableCircleDrag(circle,overlay,id,box){
  let drag=false;
  kakao.maps.event.addListener(circle,'mousedown',()=>drag=true);
  kakao.maps.event.addListener(map,'mouseup',()=>drag=false);
  kakao.maps.event.addListener(map,'mousemove',e=>{
    if(!drag) return;
    circle.setPosition(e.latLng);
    overlay.setPosition(e.latLng);
    saveState();
  });
  box.addEventListener('mousedown',e=>{
    if(e.target.tagName==='BUTTON') return;
    drag=true; e.preventDefault();
  });
  box.querySelector('button').onclick=()=>{
    circle.setMap(null); overlay.setMap(null);
    circles=circles.filter(c=>c.id!==id);
    saveState();
  };
}

function removeCircles(){
  circles.forEach(c=>{c.circle.setMap(null);c.overlay.setMap(null);});
  circles=[]; saveState();
}

/* ================= 다각형 ================= */
let polygonModeEnabled=false;
let drawingPoly=false;
let drawingPolygon=null;
let polygon=null;
let areaOverlay=null;
let deleteOverlay=null;

function togglePolygonMode(force){
  polygonModeEnabled=(force!==undefined)?force:!polygonModeEnabled;
  if(polygonModeEnabled && drawEnabled){ drawEnabled=false; drawBtn.innerText='반경 그리기 OFF'; }
  polyToggleBtn.innerText=polygonModeEnabled?'다각형 모드 ON':'다각형 모드 OFF';
}

function clearPolygon(){
  [drawingPolygon,polygon,areaOverlay,deleteOverlay].forEach(o=>o&&o.setMap(null));
  drawingPolygon=polygon=areaOverlay=deleteOverlay=null;
  saveState();
}

function showPolygonUI(){
  const area=Math.round(polygon.getArea());
  const info=document.createElement('div');
  info.className='info';
  info.style.pointerEvents='none';
  info.innerHTML=`총면적 ${area} m²`;
  areaOverlay=new kakao.maps.CustomOverlay({
    map, content:info,
    position:getCenter(polygon.getPath())
  });

  const del=document.createElement('div');
  del.className='radius-ui';
  del.innerHTML='다각형 삭제 <button>✕</button>';
  del.onclick=clearPolygon;

  deleteOverlay=new kakao.maps.CustomOverlay({
    map, content:del,
    position:getCenter(polygon.getPath()), yAnchor:1
  });

  kakao.maps.event.addListener(polygon,'drag',()=>{
    areaOverlay.setPosition(getCenter(polygon.getPath()));
    deleteOverlay.setPosition(getCenter(polygon.getPath()));
  });
  kakao.maps.event.addListener(polygon,'dragend',saveState);
}

function getCenter(path){
  const b=new kakao.maps.LatLngBounds();
  path.forEach(p=>b.extend(p));
  return b.getCenter();
}

/* ================= 지도 이벤트 ================= */
kakao.maps.event.addListener(map,'click',e=>{
  if(clickRadiusMode){
    createCircle(e.latLng,parseInt(radiusInput.value));
    clickRadiusMode=false;
    clickRadiusBtn.innerText='반경 생성';
    return;
  }
  if(drawEnabled&&!drawingFlag){
    drawingFlag=true;
    centerPosition=e.latLng;
    drawingLine=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
    drawingCircle=new kakao.maps.Circle({strokeWeight:3,strokeColor:'#ff3b3b',fillColor:'#ff6b6b',fillOpacity:.25});
    return;
  }
  if(!polygonModeEnabled) return;

  if(!drawingPoly){
    clearPolygon();
    drawingPoly=true;
    drawingPolygon=new kakao.maps.Polygon({map,path:[e.latLng],strokeWeight:3,strokeColor:'#00a0e9',fillColor:'#00a0e9',fillOpacity:.2});
    polygon=new kakao.maps.Polygon({path:[e.latLng],strokeWeight:3,strokeColor:'#00a0e9',fillColor:'#00a0e9',fillOpacity:.2, draggable:true});
  }else{
    const p1=drawingPolygon.getPath(); p1.push(e.latLng); drawingPolygon.setPath(p1);
    const p2=polygon.getPath(); p2.push(e.latLng); polygon.setPath(p2);
  }
});

kakao.maps.event.addListener(map,'mousemove',e=>{
  if(drawingFlag){
    drawingLine.setPath([centerPosition,e.latLng]);
    drawingCircle.setOptions({center:centerPosition,radius:drawingLine.getLength()});
    drawingLine.setMap(map); drawingCircle.setMap(map);
  }
  if(drawingPoly && drawingPolygon){
    const path=drawingPolygon.getPath();
    if(path.length>1) path.pop();
    path.push(e.latLng);
    drawingPolygon.setPath(path);
  }
});

kakao.maps.event.addListener(map,'rightclick',()=>{
  if(drawingFlag){
    createCircle(centerPosition,drawingLine.getLength());
    drawingLine.setMap(null); drawingCircle.setMap(null);
    drawingFlag=false; return;
  }
  if(drawingPoly){
    drawingPolygon.setMap(null); drawingPolygon=null;
    if(polygon.getPath().length>2){
      polygon.setMap(map);
      showPolygonUI();
      saveState();
    }else clearPolygon();
    drawingPoly=false;
  }
});

/* ================= 저장/복원 ================= */
function saveState(){
  const state={
    circles:circles.map(c=>({
      id:c.id,
      lat:c.circle.getPosition().getLat(),
      lng:c.circle.getPosition().getLng(),
      r:c.circle.getRadius()
    })),
    polygon: polygon ? polygon.getPath().map(p=>({lat:p.getLat(),lng:p.getLng()})) : null
  };
  localStorage.setItem('mapState',JSON.stringify(state));
}

function loadState(){
  const raw=localStorage.getItem('mapState');
  if(!raw) return;
  const s=JSON.parse(raw);
  if(s.circles) s.circles.forEach(d=>{
    createCircle(new kakao.maps.LatLng(d.lat,d.lng),d.r,d.id);
    circleIdCounter=Math.max(circleIdCounter,d.id+1);
  });
  if(s.polygon && s.polygon.length>2){
    polygon=new kakao.maps.Polygon({
      path:s.polygon.map(p=>new kakao.maps.LatLng(p.lat,p.lng)),
      strokeWeight:3,strokeColor:'#00a0e9',fillColor:'#00a0e9',fillOpacity:.2, draggable:true
    });
    polygon.setMap(map);
    showPolygonUI();
  }
}
loadState();
</script>
</body>
</html>
