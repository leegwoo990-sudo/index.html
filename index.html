<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>카카오맵 반경 + 검색 (최종본)</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
.control-box {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
  background: white;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 12px;
}
.control-box input {
  width: 140px;
  margin-bottom: 4px;
}
.control-box button {
  width: 150px;
  margin-top: 4px;
}
.radius-ui {
  background:#fff;
  border:1px solid #ccc;
  border-radius:4px;
  padding:4px 8px;
  font-size:11px;
  white-space:nowrap;
  cursor:move;
  user-select:none;
}
.radius-ui button {
  border:none;
  background:none;
  cursor:pointer;
  font-size:11px;
  color:#ff3b3b;
  margin-left:4px;
}
</style>
</head>

<body class="bg-slate-900">
<div id="map"></div>

<div class="control-box">
  <input type="text" id="keyword" placeholder="장소 검색">
  <button onclick="searchPlace()">검색</button>
  <hr>

  <input type="number" id="radiusInput" placeholder="반경 m 입력">
  <button onclick="enableClickRadius()" id="clickRadiusBtn">반경 생성</button>
  <hr>

  <button onclick="toggleDraw()" id="drawBtn">반경 그리기 OFF</button>
  <button onclick="removeCircles()">반경 모두 삭제</button>
  <hr>

  <button onclick="togglePolygonMode()" id="polyToggleBtn">다각형 모드 OFF</button>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac34ac36d4448af73f238be750e1e0e7&libraries=services"></script>

<script>
/* ================= 지도 기본 ================= */
const map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(33.450422139819736,126.5709139924533),
  level: 3
});
map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);

/* ================= 검색 ================= */
const ps = new kakao.maps.services.Places();
let searchMarkers=[];

function searchPlace(){
  const keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert('검색어 입력');

  searchMarkers.forEach(m=>m.setMap(null));
  searchMarkers=[];

  ps.keywordSearch(keyword,(data,status)=>{
    if(status!==kakao.maps.services.Status.OK) return;
    const bounds=new kakao.maps.LatLngBounds();
    data.forEach(p=>{
      const pos=new kakao.maps.LatLng(p.y,p.x);
      bounds.extend(pos);
      searchMarkers.push(new kakao.maps.Marker({map,position:pos}));
    });
    map.setBounds(bounds);
  });
}

/* ================= 상태 ================= */
let clickRadiusMode=false;
let drawEnabled=false;
let polygonMode=false;

let drawing=false;
let centerPos,line,tempCircle;

let circles=[];
let circleId=0;

let polyDrawing=false;
let polyDraft=null;
let polygon=null;
let polyDeleteOverlay=null;

/* ================= 클릭 통합 ================= */
kakao.maps.event.addListener(map,'click',function(e){

  /* 반경 입력 → 클릭 */
  if(clickRadiusMode){
    const r=+radiusInput.value;
    createCircle(e.latLng,r);
    clickRadiusMode=false;
    clickRadiusBtn.innerText='반경 생성';
    return;
  }

  /* 다각형 */
  if(polygonMode){
    handlePolygonClick(e.latLng);
    return;
  }

  /* 드래그 반경 시작 */
  if(!drawEnabled || drawing) return;
  drawing=true;
  centerPos=e.latLng;

  line=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
  tempCircle=new kakao.maps.Circle({
    strokeWeight:3,
    strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',
    fillOpacity:0.25
  });
});

/* ================= 마우스 이동 ================= */
kakao.maps.event.addListener(map,'mousemove',function(e){
  if(drawing){
    line.setPath([centerPos,e.latLng]);
    const r=line.getLength();
    if(r>0){
      tempCircle.setOptions({center:centerPos,radius:r});
      line.setMap(map);
      tempCircle.setMap(map);
    }
  }

  if(polyDrawing && polyDraft){
    const path=polyDraft.getPath();
    if(path.length>1) path.pop();
    path.push(e.latLng);
    polyDraft.setPath(path);
  }
});

/* ================= 우클릭 ================= */
kakao.maps.event.addListener(map,'rightclick',function(){
  if(drawing){
    createCircle(centerPos,line.getLength());
    line.setMap(null);
    tempCircle.setMap(null);
    drawing=false;
  }

  if(polyDrawing){
    finishPolygon();
  }
});

/* ================= 원 ================= */
function enableClickRadius(){
  if(!radiusInput.value) return alert('반경 입력');
  clickRadiusMode=true;
  clickRadiusBtn.innerText='지도 클릭 대기중...';
}

function toggleDraw(){
  drawEnabled=!drawEnabled;
  if(drawEnabled && polygonMode) togglePolygonMode();
  drawBtn.innerText=drawEnabled?'반경 그리기 ON':'반경 그리기 OFF';
}

function createCircle(pos,r,id){
  const cid=(id??circleId++);
  const circle=new kakao.maps.Circle({
    map,
    center:pos,
    radius:r,
    strokeWeight:3,
    strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',
    fillOpacity:0.25
  });

  const box=document.createElement('div');
  box.className='radius-ui';
  box.innerHTML=`${Math.round(r)}m <button>✕</button>`;

  const overlay=new kakao.maps.CustomOverlay({
    map,
    position:pos,
    content:box,
    yAnchor:1
  });

  enableDrag(circle,overlay,box,cid);
  circles.push({id:cid,circle,overlay});
  saveState();
}

function enableDrag(circle,overlay,box,id){
  let drag=false;

  kakao.maps.event.addListener(circle,'mousedown',()=>drag=true);
  kakao.maps.event.addListener(map,'mouseup',()=>{
    if(drag) saveState();
    drag=false;
  });

  kakao.maps.event.addListener(map,'mousemove',e=>{
    if(!drag) return;
    circle.setPosition(e.latLng);
    overlay.setPosition(e.latLng);
  });

  box.addEventListener('mousedown',e=>{
    if(e.target.tagName==='BUTTON') return;
    drag=true;
    e.preventDefault();
  });

  box.querySelector('button').onclick=()=>{
    const i=circles.findIndex(c=>c.id===id);
    circles[i].circle.setMap(null);
    circles[i].overlay.setMap(null);
    circles.splice(i,1);
    saveState();
  };
}

function removeCircles(){
  circles.forEach(c=>{
    c.circle.setMap(null);
    c.overlay.setMap(null);
  });
  circles=[];
  saveState();
}

/* ================= 다각형 ================= */
function togglePolygonMode(){
  polygonMode=!polygonMode;
  if(polygonMode && drawEnabled) toggleDraw();
  polyToggleBtn.innerText=polygonMode?'다각형 모드 ON':'다각형 모드 OFF';
}

function handlePolygonClick(pos){
  if(!polyDrawing){
    clearPolygon();
    polyDrawing=true;
    polyDraft=new kakao.maps.Polygon({map,path:[pos],strokeWeight:3,strokeColor:'#00a0e9',fillOpacity:0.2});
    polygon=new kakao.maps.Polygon({path:[pos],strokeWeight:3,strokeColor:'#00a0e9',fillOpacity:0.2});
  }else{
    polyDraft.getPath().push(pos);
    polygon.getPath().push(pos);
  }
}

function finishPolygon(){
  if(polyDraft) polyDraft.setMap(null);
  polyDraft=null;
  polyDrawing=false;

  if(polygon.getPath().length<3){
    clearPolygon();
    saveState();
    return;
  }

  polygon.setMap(map);
  showPolygonDelete();
  saveState();
}

function showPolygonDelete(){
  const bounds=new kakao.maps.LatLngBounds();
  polygon.getPath().forEach(p=>bounds.extend(p));
  const center=bounds.getCenter();

  const box=document.createElement('div');
  box.className='radius-ui';
  box.innerHTML='다각형 삭제 <button>✕</button>';
  box.onclick=()=>{ clearPolygon(); saveState(); };

  polyDeleteOverlay=new kakao.maps.CustomOverlay({
    map,
    position:center,
    content:box,
    yAnchor:1
  });
}

function clearPolygon(){
  if(polygon) polygon.setMap(null);
  if(polyDraft) polyDraft.setMap(null);
  if(polyDeleteOverlay) polyDeleteOverlay.setMap(null);
  polygon=polyDraft=polyDeleteOverlay=null;
}

/* ================= 저장 ================= */
function saveState(){
  localStorage.setItem('mapState',JSON.stringify({
    circles:circles.map(c=>({
      id:c.id,
      lat:c.circle.getPosition().getLat(),
      lng:c.circle.getPosition().getLng(),
      r:c.circle.getRadius()
    })),
    polygon:polygon?polygon.getPath().map(p=>({lat:p.getLat(),lng:p.getLng()})):null
  }));
}

(function load(){
  const s=JSON.parse(localStorage.getItem('mapState')||'{}');
  if(s.circles) s.circles.forEach(d=>{
    createCircle(new kakao.maps.LatLng(d.lat,d.lng),d.r,d.id);
    circleId=Math.max(circleId,d.id+1);
  });
  if(s.polygon && s.polygon.length>2){
    polygon=new kakao.maps.Polygon({
      map,
      path:s.polygon.map(p=>new kakao.maps.LatLng(p.lat,p.lng)),
      strokeWeight:3,
      strokeColor:'#00a0e9',
      fillOpacity:0.2
    });
    showPolygonDelete();
  }
})();
</script>
</body>
</html>
