<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì¹´ì¹´ì˜¤ë§µ ë°˜ê²½ + ê²€ìƒ‰ (ìµœì¢…ë³¸)</title>
<title>ì¹´ì¹´ì˜¤ë§µ ë°˜ê²½ + ê²€ìƒ‰ (GitHub Pagesìš©)</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<style>
html, body {
width: 100%;
@@ -34,14 +33,15 @@
width: 150px;
margin-top: 4px;
}

.radius-ui {
background:#fff;
border:1px solid #ccc;
border-radius:4px;
padding:4px 8px;
font-size:11px;
white-space:nowrap;
  cursor:move;
  cursor:move; /* ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš© */
user-select:none;
}
.radius-ui button {
@@ -56,7 +56,8 @@
</head>

<body class="bg-slate-900">
<div id="map"></div>

<div id="map" style="width:100%; height:100%;"></div>

<div class="control-box">
<input type="text" id="keyword" placeholder="ì¥ì†Œ ê²€ìƒ‰">
@@ -65,201 +66,229 @@

<input type="number" id="radiusInput" placeholder="ë°˜ê²½ m ì…ë ¥">
<button onclick="enableClickRadius()" id="clickRadiusBtn">ë°˜ê²½ ìƒì„±</button>
  <hr>

  <hr>
<button onclick="toggleDraw()" id="drawBtn">ë°˜ê²½ ê·¸ë¦¬ê¸° OFF</button>
<button onclick="removeCircles()">ë°˜ê²½ ëª¨ë‘ ì‚­ì œ</button>
  <hr>

  <button onclick="togglePolygonMode()" id="polyToggleBtn">ë‹¤ê°í˜• ëª¨ë“œ OFF</button>
  <hr>
  <!-- ê¸°ëŠ¥ í† ê¸€ ì•„ì´ì½˜ ë²„íŠ¼ë“¤ -->
  <div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px;">
    <button id="polyToggleBtn" onclick="togglePolygonMode()">ë‹¤ê°í˜• ëª¨ë“œ OFF</button>
  </div>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac34ac36d4448af73f238be750e1e0e7&libraries=services"></script>

<script>
/* ================= ì§€ë„ ê¸°ë³¸ ================= */
const map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(33.450422139819736,126.5709139924533),
var mapContainer = document.getElementById('map'); // ì§€ë„ë¥¼ í‘œì‹œí•  div
var mapCenter = new kakao.maps.LatLng(33.450422139819736 , 126.5709139924533); // ì§€ë„ì˜ ê°€ìš´ë° ì¢Œí‘œ
var mapOption = {
  center: mapCenter,
level: 3
});
map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
};

/* ================= ê²€ìƒ‰ ================= */
const ps = new kakao.maps.services.Places();
let searchMarkers=[];
/* ì§€ë„ */
var map = new kakao.maps.Map(mapContainer, mapOption);

// ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•œë‹¤
var mapTypeControl = new kakao.maps.MapTypeControl();

// ì§€ë„ì˜ ìƒë‹¨ ìš°ì¸¡ì— ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•œë‹¤
map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

/* ê²€ìƒ‰ */
var ps = new kakao.maps.services.Places();
var searchMarkers = [];

function searchPlace(){
  const keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert('ê²€ìƒ‰ì–´ ì…ë ¥');
  var keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert("ê²€ìƒ‰ì–´ ì…ë ¥");

searchMarkers.forEach(m=>m.setMap(null));
searchMarkers=[];

  ps.keywordSearch(keyword,(data,status)=>{
  ps.keywordSearch(keyword,function(data,status){
if(status!==kakao.maps.services.Status.OK) return;
    const bounds=new kakao.maps.LatLngBounds();
    var bounds=new kakao.maps.LatLngBounds();
data.forEach(p=>{
      const pos=new kakao.maps.LatLng(p.y,p.x);
      var pos=new kakao.maps.LatLng(p.y,p.x);
bounds.extend(pos);
      searchMarkers.push(new kakao.maps.Marker({map,position:pos}));
      var m=new kakao.maps.Marker({position:pos,map});
      searchMarkers.push(m);
});
map.setBounds(bounds);
});
}

/* ================= ìƒíƒœ ================= */
let clickRadiusMode=false;
let drawEnabled=false;
let polygonMode=false;
/* ===== ë°˜ê²½ m ì…ë ¥ í›„ í´ë¦­ ìƒì„± ===== */
var clickRadiusMode = false;
var clickRadiusBtn = document.getElementById('clickRadiusBtn');

function enableClickRadius(){
  var r = parseInt(document.getElementById('radiusInput').value);
  if(!r || r<=0) return alert("ë°˜ê²½(m)ì„ ì…ë ¥í•˜ì„¸ìš”");

  clickRadiusMode = true;
  clickRadiusBtn.innerText = "ì§€ë„ í´ë¦­ ëŒ€ê¸°ì¤‘...";
}

let drawing=false;
let centerPos,line,tempCircle;
/* ë°˜ê²½ ê·¸ë¦¬ê¸° ON/OFF */
var drawEnabled=false;
var drawBtn = document.getElementById('drawBtn');

let circles=[];
let circleId=0;
function toggleDraw(){
  drawEnabled=!drawEnabled;
  // ë°˜ê²½ ê·¸ë¦¬ê¸°ê°€ ì¼œì§ˆ ë•Œ ë‹¤ê°í˜• ëª¨ë“œëŠ” ìë™ìœ¼ë¡œ OFF
  if (drawEnabled && polygonModeEnabled){
    polygonModeEnabled = false;
    document.getElementById('polyToggleBtn').innerText = 'ë‹¤ê°í˜• ëª¨ë“œ OFF';
  }
  drawBtn.innerText=drawEnabled?"ë°˜ê²½ ê·¸ë¦¬ê¸° ON":"ë°˜ê²½ ê·¸ë¦¬ê¸° OFF";
}

let polyDrawing=false;
let polyDraft=null;
let polygon=null;
let polyDeleteOverlay=null;
/* ë§ˆìš°ìŠ¤ë¡œ ë°˜ê²½ ê·¸ë¦¬ê¸° */
var drawingFlag=false, centerPosition;
var drawingLine, drawingCircle;
var circles=[]; // {id, circle, overlay}
var circleIdCounter = 0; // ê³ ìœ  ID ë°œê¸‰ìš©

/* ================= í´ë¦­ í†µí•© ================= */
kakao.maps.event.addListener(map,'click',function(e){

  /* ë°˜ê²½ ì…ë ¥ â†’ í´ë¦­ */
  /* ğŸ”¹ ë°˜ê²½ ì…ë ¥ â†’ í´ë¦­ ìƒì„± */
if(clickRadiusMode){
    const r=+radiusInput.value;
    createCircle(e.latLng,r);
    clickRadiusMode=false;
    clickRadiusBtn.innerText='ë°˜ê²½ ìƒì„±';
    return;
  }
    var r = parseInt(document.getElementById('radiusInput').value);
    createCircle(e.latLng, r);

  /* ë‹¤ê°í˜• */
  if(polygonMode){
    handlePolygonClick(e.latLng);
    clickRadiusMode = false;
    clickRadiusBtn.innerText = "ë°˜ê²½ ìƒì„±";
return;
}

  /* ë“œë˜ê·¸ ë°˜ê²½ ì‹œì‘ */
  if(!drawEnabled || drawing) return;
  drawing=true;
  centerPos=e.latLng;
  /* ğŸ”¹ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ë°˜ê²½ */
  if(!drawEnabled||drawingFlag) return;
  drawingFlag=true;
  centerPosition=e.latLng;

  line=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
  tempCircle=new kakao.maps.Circle({
    strokeWeight:3,
    strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',
    fillOpacity:0.25
  drawingLine=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
  drawingCircle=new kakao.maps.Circle({
    strokeWeight:3,strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',fillOpacity:0.25
});
});

/* ================= ë§ˆìš°ìŠ¤ ì´ë™ ================= */
kakao.maps.event.addListener(map,'mousemove',function(e){
  if(drawing){
    line.setPath([centerPos,e.latLng]);
    const r=line.getLength();
    if(r>0){
      tempCircle.setOptions({center:centerPos,radius:r});
      line.setMap(map);
      tempCircle.setMap(map);
    }
  }

  if(polyDrawing && polyDraft){
    const path=polyDraft.getPath();
    if(path.length>1) path.pop();
    path.push(e.latLng);
    polyDraft.setPath(path);
  if(!drawingFlag) return;
  drawingLine.setPath([centerPosition,e.latLng]);
  var r=drawingLine.getLength();
  if(r>0){
    drawingCircle.setOptions({center:centerPosition,radius:r});
    drawingCircle.setMap(map);
    drawingLine.setMap(map);
}
});

/* ================= ìš°í´ë¦­ ================= */
kakao.maps.event.addListener(map,'rightclick',function(){
  if(drawing){
    createCircle(centerPos,line.getLength());
    line.setMap(null);
    tempCircle.setMap(null);
    drawing=false;
  }

  if(polyDrawing){
    finishPolygon();
  }
  if(!drawingFlag) return;
  createCircle(centerPosition,drawingLine.getLength());
  drawingCircle.setMap(null);
  drawingLine.setMap(null);
  drawingFlag=false;
  saveState();
});

/* ================= ì› ================= */
function enableClickRadius(){
  if(!radiusInput.value) return alert('ë°˜ê²½ ì…ë ¥');
  clickRadiusMode=true;
  clickRadiusBtn.innerText='ì§€ë„ í´ë¦­ ëŒ€ê¸°ì¤‘...';
}

function toggleDraw(){
  drawEnabled=!drawEnabled;
  if(drawEnabled && polygonMode) togglePolygonMode();
  drawBtn.innerText=drawEnabled?'ë°˜ê²½ ê·¸ë¦¬ê¸° ON':'ë°˜ê²½ ê·¸ë¦¬ê¸° OFF';
}

function createCircle(pos,r,id){
  const cid=(id??circleId++);
  const circle=new kakao.maps.Circle({
    map,
    center:pos,
    radius:r,
/* ë°˜ê²½ ìƒì„± + ë“œë˜ê·¸ + ê°œë³„ì‚­ì œ (ID ê¸°ë°˜) */
function createCircle(center,radius, id){
  var circle=new kakao.maps.Circle({
    center:center,
    radius:radius,
strokeWeight:3,
strokeColor:'#ff3b3b',
fillColor:'#ff6b6b',
fillOpacity:0.25
});
  circle.setMap(map);

  // ê³ ìœ  ID ë¶€ì—¬ (ë³µì› ì‹œì—ëŠ” ì „ë‹¬ëœ id ì‚¬ìš©)
  var cid = (typeof id === 'number') ? id : circleIdCounter++;

  const box=document.createElement('div');
  box.className='radius-ui';
  box.innerHTML=`${Math.round(r)}m <button>âœ•</button>`;
  // í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ data ì†ì„±ì— id ë¶€ì—¬
  var content = document.createElement('div');
  content.className = 'radius-ui';
  content.setAttribute('data-circle-id', cid);
  content.innerHTML = `${Math.round(radius)}m <button type="button" data-remove-id="${cid}">âœ•</button>`;

  const overlay=new kakao.maps.CustomOverlay({
    map,
    position:pos,
    content:box,
  var overlay=new kakao.maps.CustomOverlay({
    position:center,
    content:content,
yAnchor:1
});
  overlay.setMap(map);

  enableDrag(circle,overlay,cid,content);
  circles.push({id: cid, circle: circle, overlay: overlay});

  enableDrag(circle,overlay,box,cid);
  circles.push({id:cid,circle,overlay});
  // ìƒì„± í›„ ì €ì¥
saveState();
}

function enableDrag(circle,overlay,box,id){
  let drag=false;
/* ë“œë˜ê·¸ ì´ë™ (ì› + í…ìŠ¤íŠ¸ ë°•ìŠ¤ ëª¨ë‘ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ) */
function enableDrag(circle,overlay,cid,contentEl){
  // ê³µí†µ ìƒíƒœ
  let isDragging = false;

  kakao.maps.event.addListener(circle,'mousedown',()=>drag=true);
  kakao.maps.event.addListener(map,'mouseup',()=>{
    if(drag) saveState();
    drag=false;
  });
  // ë“œë˜ê·¸ ì‹œì‘ / ì¢…ë£Œ í—¬í¼
  function startDrag(){
    isDragging = true;
  }
  function endDrag(){
    isDragging = false;
  }

  kakao.maps.event.addListener(map,'mousemove',e=>{
    if(!drag) return;
  // ì›ì„ ì§ì ‘ ë“œë˜ê·¸ (ì› í´ë¦­ ë²”ìœ„ê°€ ì¢ì„ ìˆ˜ ìˆì–´ì„œ, ì´ë²¤íŠ¸ë§Œ ìœ ì§€)
  kakao.maps.event.addListener(circle,'mousedown', startDrag);

  // ë§µ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
  kakao.maps.event.addListener(map,'mouseup', endDrag);

  // ìœˆë„ìš° ì–´ë””ì„œë“  ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ (ë§µ ë°–ìœ¼ë¡œ ë‚˜ê°€ë„ ëŠê¹€ ë°©ì§€)
  window.addEventListener('mouseup', endDrag);

  // ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ìœ„ì¹˜ ê°±ì‹ 
  kakao.maps.event.addListener(map,'mousemove', function(e){
    if(!isDragging) return;
circle.setPosition(e.latLng);
overlay.setPosition(e.latLng);
    saveState();
});

  box.addEventListener('mousedown',e=>{
    if(e.target.tagName==='BUTTON') return;
    drag=true;
    e.preventDefault();
  // í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš©
  contentEl.addEventListener('mousedown', function(ev){
    // ì‚­ì œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
    if (ev.target && ev.target.getAttribute('data-remove-id')) return;
    startDrag();
    ev.preventDefault();
});

  box.querySelector('button').onclick=()=>{
    const i=circles.findIndex(c=>c.id===id);
    circles[i].circle.setMap(null);
    circles[i].overlay.setMap(null);
    circles.splice(i,1);
    saveState();
  };
  // ì‚­ì œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ë§
  contentEl.addEventListener('click', function(ev){
    var rid = ev.target && ev.target.getAttribute('data-remove-id');
    if (!rid) return;
    handleRemoveOne(parseInt(rid,10));
  });
}

/* ê°œë³„ ì‚­ì œ: IDë¡œ ì°¾ê¸° */
function handleRemoveOne(id){
  var idx = circles.findIndex(c => c.id === id);
  if(idx === -1) return;
  circles[idx].circle.setMap(null);
  circles[idx].overlay.setMap(null);
  circles.splice(idx,1);
  saveState();
}

/* ì „ì²´ ì‚­ì œ */
function removeCircles(){
circles.forEach(c=>{
c.circle.setMap(null);
@@ -269,96 +298,270 @@
saveState();
}

/* ================= ë‹¤ê°í˜• ================= */
function togglePolygonMode(){
  polygonMode=!polygonMode;
  if(polygonMode && drawEnabled) toggleDraw();
  polyToggleBtn.innerText=polygonMode?'ë‹¤ê°í˜• ëª¨ë“œ ON':'ë‹¤ê°í˜• ëª¨ë“œ OFF';
// ===== ë‹¤ê°í˜•(ë©´ì ) ê·¸ë¦¬ê¸° ê¸°ëŠ¥ ì¶”ê°€ =====
// ì› ë°˜ê²½ ê¸°ëŠ¥ê³¼ ë³„ë„ë¡œ, ì§€ë„ í´ë¦­ìœ¼ë¡œ ë‹¤ê°í˜•ì„ ê·¸ë¦¬ê³ 
// ìš°í´ë¦­ìœ¼ë¡œ ë©´ì (mÂ²)ì„ í‘œì‹œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

var polygonModeEnabled = false;   // ë‹¤ê°í˜• ëª¨ë“œ í† ê¸€ í”Œë˜ê·¸
var drawingPoly = false;          // ë‹¤ê°í˜• ê·¸ë¦¬ê¸° ìƒíƒœ
var drawingPolygon = null;        // ê·¸ë ¤ì§€ê³  ìˆëŠ” ë‹¤ê°í˜•
var polygon = null;               // ì™„ì„±ëœ ë‹¤ê°í˜•
var areaOverlay = null;           // ë©´ì  ì •ë³´ ì˜¤ë²„ë ˆì´
var polygonDeleteOverlay = null;  // ë‹¤ê°í˜• ì‚­ì œ ë²„íŠ¼ ì˜¤ë²„ë ˆì´

// ë‹¤ê°í˜• ì‚­ì œ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
function clearPolygon() {
  if (polygon) { polygon.setMap(null); polygon = null; }
  if (areaOverlay) { areaOverlay.setMap(null); areaOverlay = null; }
  if (polygonDeleteOverlay) { polygonDeleteOverlay.setMap(null); polygonDeleteOverlay = null; }
  saveState(); // ìƒíƒœ ì €ì¥ (ë‹¤ê°í˜• ì‚­ì œ ë°˜ì˜)
}

function handlePolygonClick(pos){
  if(!polyDrawing){
    clearPolygon();
    polyDrawing=true;
    polyDraft=new kakao.maps.Polygon({map,path:[pos],strokeWeight:3,strokeColor:'#00a0e9',fillOpacity:0.2});
    polygon=new kakao.maps.Polygon({path:[pos],strokeWeight:3,strokeColor:'#00a0e9',fillOpacity:0.2});
  }else{
    polyDraft.getPath().push(pos);
    polygon.getPath().push(pos);
// ë‹¤ê°í˜• UI ìƒì„± (ë©´ì  + ì‚­ì œ ë²„íŠ¼)
function showPolygonUI(path) {
  // ë©´ì  ê³„ì‚° ë° í‘œì‹œ
  var area = Math.round(polygon.getArea());

  // ì´ë©´ì  ì˜¤ë²„ë ˆì´: í´ë¦­ ì™„ì „ ë¬´ì‹œ (pointer-events:none + ì»¤ì„œ ê¸°ë³¸)
  var infoDiv = document.createElement('div');
  infoDiv.className = 'info';
  infoDiv.style.pointerEvents = 'none';
  infoDiv.style.cursor = 'default';
  infoDiv.innerHTML = 'ì´ë©´ì  <span class="number">' + area + '</span> m<sup>2</sup>';

  if (areaOverlay) { areaOverlay.setMap(null); areaOverlay = null; }

  areaOverlay = new kakao.maps.CustomOverlay({
    map: map,
    content: infoDiv,
    xAnchor: 0,
    yAnchor: 0,
    position: path[path.length - 1]
  });

  // ê¸°ì¡´ ì‚­ì œ ì˜¤ë²„ë ˆì´ ì œê±°
  if (polygonDeleteOverlay) {
    polygonDeleteOverlay.setMap(null);
    polygonDeleteOverlay = null;
}

  // ë‹¤ê°í˜• ì¤‘ì‹¬ ê³„ì‚° í›„ ì‚­ì œ ë°•ìŠ¤ ìƒì„±
  var bounds = new kakao.maps.LatLngBounds();
  path.forEach(function (p) { bounds.extend(p); });
  var center = bounds.getCenter();

  var delContent = document.createElement('div');
  delContent.className = 'radius-ui';
  delContent.innerHTML = 'ë‹¤ê°í˜• ì‚­ì œ <button type="button">âœ•</button>';
  delContent.style.cursor = 'pointer';
  delContent.addEventListener('click', function () {
    clearPolygon();
  });

  polygonDeleteOverlay = new kakao.maps.CustomOverlay({
    map: map,
    content: delContent,
    position: center,
    yAnchor: 1
  });
}

function finishPolygon(){
  if(polyDraft) polyDraft.setMap(null);
  polyDraft=null;
  polyDrawing=false;
// ì§€ë„ í´ë¦­: ë‹¤ê°í˜• ê·¸ë¦¬ê¸° ì‹œì‘/ì—°ì¥
kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
  // ë°˜ê²½ ë“œë¡œì‰ ì¤‘ì´ê±°ë‚˜ ë‹¤ê°í˜• ëª¨ë“œê°€ êº¼ì ¸ ìˆìœ¼ë©´ ë¬´ì‹œ
  if (drawingFlag || !polygonModeEnabled) return;

  if(polygon.getPath().length<3){
  var clickPosition = mouseEvent.latLng;

  if (!drawingPoly) {
    drawingPoly = true;

    // ê¸°ì¡´ ë‹¤ê°í˜• / ë©´ì  / ì‚­ì œ ë°•ìŠ¤ ì œê±°
clearPolygon();
    saveState();
    return;

    // ê·¸ë ¤ì§€ê³  ìˆëŠ” ë‹¤ê°í˜•
    drawingPolygon = new kakao.maps.Polygon({
      map: map,
      path: [clickPosition],
      strokeWeight: 3,
      strokeColor: '#00a0e9',
      strokeOpacity: 1,
      strokeStyle: 'solid',
      fillColor: '#00a0e9',
      fillOpacity: 0.2
    });

    // ì™„ì„±ë  ë‹¤ê°í˜•
    polygon = new kakao.maps.Polygon({
      path: [clickPosition],
      strokeWeight: 3,
      strokeColor: '#00a0e9',
      strokeOpacity: 1,
      strokeStyle: 'solid',
      fillColor: '#00a0e9',
      fillOpacity: 0.2
    });

  } else {
    // ì¢Œí‘œ ì¶”ê°€
    var drawingPath = drawingPolygon.getPath();
    drawingPath.push(clickPosition);
    drawingPolygon.setPath(drawingPath);

    var path = polygon.getPath();
    path.push(clickPosition);
    polygon.setPath(path);
  }
});

// ì§€ë„ ë§ˆìš°ìŠ¤ë¬´ë¸Œ: ê·¸ë ¤ì§ˆ ë‹¤ê°í˜•ì˜ ë§ˆì§€ë§‰ ê¼­ì§“ì ì„ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¡œ ë³´ì—¬ì¤Œ
kakao.maps.event.addListener(map, 'mousemove', function (mouseEvent) {
  if (!drawingPoly || !drawingPolygon) return;

  var mousePosition = mouseEvent.latLng;
  var path = drawingPolygon.getPath();

  if (path.length > 1) {
    path.pop();
}

  polygon.setMap(map);
  showPolygonDelete();
  saveState();
}
  path.push(mousePosition);
  drawingPolygon.setPath(path);
});

function showPolygonDelete(){
  const bounds=new kakao.maps.LatLngBounds();
  polygon.getPath().forEach(p=>bounds.extend(p));
  const center=bounds.getCenter();
// ì§€ë„ ìš°í´ë¦­: ë‹¤ê°í˜• ê·¸ë¦¬ê¸° ì¢…ë£Œ + ë©´ì  í‘œì‹œ + ì‚­ì œ ë°•ìŠ¤ ìƒì„±
kakao.maps.event.addListener(map, 'rightclick', function () {
  if (!drawingPoly) return;

  const box=document.createElement('div');
  box.className='radius-ui';
  box.innerHTML='ë‹¤ê°í˜• ì‚­ì œ <button>âœ•</button>';
  box.onclick=()=>{ clearPolygon(); saveState(); };
  // ì„ì‹œ ê·¸ë¦¬ê¸°ìš© ë‹¤ê°í˜• ì œê±°
  if (drawingPolygon) {
    drawingPolygon.setMap(null);
    drawingPolygon = null;
  }

  polyDeleteOverlay=new kakao.maps.CustomOverlay({
    map,
    position:center,
    content:box,
    yAnchor:1
  });
}
  if (polygon) {
    var path = polygon.getPath();

    if (path.length > 2) {
      // ë‹¤ê°í˜• ì§€ë„ì— í‘œì‹œ
      polygon.setMap(map);

      // UI(ë©´ì  + ì‚­ì œ ë°•ìŠ¤) ìƒì„±
      showPolygonUI(path);

function clearPolygon(){
  if(polygon) polygon.setMap(null);
  if(polyDraft) polyDraft.setMap(null);
  if(polyDeleteOverlay) polyDeleteOverlay.setMap(null);
  polygon=polyDraft=polyDeleteOverlay=null;
      // ìƒíƒœ ì €ì¥: ë‹¤ê°í˜• ì¢Œí‘œë„ í•¨ê»˜ ì €ì¥
      saveState();
    } else {
      clearPolygon();
    }
  }

  drawingPoly = false;
});

// ===== ê¸°ëŠ¥ í† ê¸€ í•¨ìˆ˜ë“¤ =====
function togglePolygonMode() {
  polygonModeEnabled = !polygonModeEnabled;

  // ë‹¤ê°í˜• ëª¨ë“œê°€ ì¼œì§€ë©´ ë°˜ê²½ ê·¸ë¦¬ê¸°ëŠ” ìë™ìœ¼ë¡œ OFF
  if (polygonModeEnabled && drawEnabled) {
    drawEnabled = false;
    drawBtn.innerText = 'ë°˜ê²½ ê·¸ë¦¬ê¸° OFF';
  }

  var btn = document.getElementById('polyToggleBtn');
  if (btn) {
    btn.innerText = polygonModeEnabled ? 'ë‹¤ê°í˜• ëª¨ë“œ ON' : 'ë‹¤ê°í˜• ëª¨ë“œ OFF';
  }
}

/* ================= ì €ì¥ ================= */
function saveState(){
  localStorage.setItem('mapState',JSON.stringify({
    circles:circles.map(c=>({
      id:c.id,
      lat:c.circle.getPosition().getLat(),
      lng:c.circle.getPosition().getLng(),
      r:c.circle.getRadius()
    })),
    polygon:polygon?polygon.getPath().map(p=>({lat:p.getLat(),lng:p.getLng()})):null
  }));
// ì›(circle) + ë‹¤ê°í˜• ìƒíƒœ ì €ì¥/ë³µì›
function saveState() {
  var state = {
    circles: circles.map(function (c) {
      return {
        id: c.id,
        lat: c.circle.getPosition().getLat(),
        lng: c.circle.getPosition().getLng(),
        r: c.circle.getRadius()
      };
    }),
    polygon: null
  };

  // ë‹¤ê°í˜•ì´ ìˆìœ¼ë©´ ì¢Œí‘œ ì €ì¥
  if (polygon && polygon.getPath) {
    var path = polygon.getPath();
    if (path && path.length > 2) {
      state.polygon = path.map(function (p) {
        return { lat: p.getLat(), lng: p.getLng() };
      });
    }
  }

  localStorage.setItem('mapState', JSON.stringify(state));
}

(function load(){
  const s=JSON.parse(localStorage.getItem('mapState')||'{}');
  if(s.circles) s.circles.forEach(d=>{
    createCircle(new kakao.maps.LatLng(d.lat,d.lng),d.r,d.id);
    circleId=Math.max(circleId,d.id+1);
function restorePolygonFromState(pathCoords) {
  if (!pathCoords || !Array.isArray(pathCoords) || pathCoords.length < 3) return;

  // ê¸°ì¡´ ë‹¤ê°í˜•/ì˜¤ë²„ë ˆì´ ì œê±°
  clearPolygon();

  var path = pathCoords.map(function (d) {
    return new kakao.maps.LatLng(d.lat, d.lng);
  });

  polygon = new kakao.maps.Polygon({
    path: path,
    strokeWeight: 3,
    strokeColor: '#00a0e9',
    strokeOpacity: 1,
    strokeStyle: 'solid',
    fillColor: '#00a0e9',
    fillOpacity: 0.2
});
  if(s.polygon && s.polygon.length>2){
    polygon=new kakao.maps.Polygon({
      map,
      path:s.polygon.map(p=>new kakao.maps.LatLng(p.lat,p.lng)),
      strokeWeight:3,
      strokeColor:'#00a0e9',
      fillOpacity:0.2
  polygon.setMap(map);

  // UI(ë©´ì  + ì‚­ì œ ë°•ìŠ¤) ìƒì„±
  showPolygonUI(path);
}

function loadState() {
  try {
    var raw = localStorage.getItem('mapState');
    if (!raw) return;
    var state = JSON.parse(raw);

    // ê¸°ì¡´ ì› ì œê±°
    circles.forEach(function (c) {
      c.circle.setMap(null);
      c.overlay.setMap(null);
});
    showPolygonDelete();
    circles = [];

    // ì› ë³µì›
    if (state.circles && Array.isArray(state.circles)) {
      state.circles.forEach(function (d) {
        createCircle(new kakao.maps.LatLng(d.lat, d.lng), d.r, d.id);
        if (typeof d.id === 'number' && d.id >= circleIdCounter) {
          circleIdCounter = d.id + 1;
        }
      });
    }

    // ë‹¤ê°í˜• ë³µì›
    if (state.polygon) {
      restorePolygonFromState(state.polygon);
    }
  } catch (e) {
    console.error('ì €ì¥ëœ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', e);
}
})();
}

// ì´ˆê¸° ë¡œë”© ì‹œ ìƒíƒœ ë³µì›
loadState();
</script>

</body>
</html>
