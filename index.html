<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì¹´ì¹´ì˜¤ë§µ ë°˜ê²½ + ê²€ìƒ‰ (GitHub Pagesìš©)</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
.control-box {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
  background: white;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 12px;
}
.control-box input {
  width: 140px;
  margin-bottom: 4px;
}
.control-box button {
  width: 150px;
  margin-top: 4px;
}

.radius-ui {
  background:#fff;
  border:1px solid #ccc;
  border-radius:4px;
  padding:4px 8px;
  font-size:11px;
  white-space:nowrap;
  cursor:move; /* ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš© */
  user-select:none;
}
.radius-ui button {
  border:none;
  background:none;
  cursor:pointer;
  font-size:11px;
  color:#ff3b3b;
  margin-left:4px;
}
</style>
</head>

<body class="bg-slate-900">

<div id="map" style="width:100%; height:100%;"></div>

<div class="control-box">
  <input type="text" id="keyword" placeholder="ì¥ì†Œ ê²€ìƒ‰">
  <button onclick="searchPlace()">ê²€ìƒ‰</button>
  <hr>

  <input type="number" id="radiusInput" placeholder="ë°˜ê²½ m ì…ë ¥">
  <button onclick="enableClickRadius()" id="clickRadiusBtn">ë°˜ê²½ ìƒì„±</button>

  <hr>
  <button onclick="toggleDraw()" id="drawBtn">ë°˜ê²½ ê·¸ë¦¬ê¸° OFF</button>
  <button onclick="removeCircles()">ë°˜ê²½ ëª¨ë‘ ì‚­ì œ</button>

  <hr>
  <!-- ê¸°ëŠ¥ í† ê¸€ ì•„ì´ì½˜ ë²„íŠ¼ë“¤ -->
  <div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px;">
    <button id="polyToggleBtn" onclick="togglePolygonMode()">ë‹¤ê°í˜• ëª¨ë“œ OFF</button>
  </div>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac34ac36d4448af73f238be750e1e0e7&libraries=services"></script>

<script>
var mapContainer = document.getElementById('map'); // ì§€ë„ë¥¼ í‘œì‹œí•  div
var mapCenter = new kakao.maps.LatLng(33.450422139819736 , 126.5709139924533); // ì§€ë„ì˜ ê°€ìš´ë° ì¢Œí‘œ
var mapOption = {
  center: mapCenter,
  level: 3
};

/* ì§€ë„ */
var map = new kakao.maps.Map(mapContainer, mapOption);

// ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•œë‹¤
var mapTypeControl = new kakao.maps.MapTypeControl();

// ì§€ë„ì˜ ìƒë‹¨ ìš°ì¸¡ì— ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•œë‹¤
map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

/* ê²€ìƒ‰ */
var ps = new kakao.maps.services.Places();
var searchMarkers = [];

function searchPlace(){
  var keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert("ê²€ìƒ‰ì–´ ì…ë ¥");

  searchMarkers.forEach(m=>m.setMap(null));
  searchMarkers=[];

  ps.keywordSearch(keyword,function(data,status){
    if(status!==kakao.maps.services.Status.OK) return;
    var bounds=new kakao.maps.LatLngBounds();
    data.forEach(p=>{
      var pos=new kakao.maps.LatLng(p.y,p.x);
      bounds.extend(pos);
      var m=new kakao.maps.Marker({position:pos,map});
      searchMarkers.push(m);
    });
    map.setBounds(bounds);
  });
}

/* ===== ë°˜ê²½ m ì…ë ¥ í›„ í´ë¦­ ìƒì„± ===== */
var clickRadiusMode = false;
var clickRadiusBtn = document.getElementById('clickRadiusBtn');

function enableClickRadius(){
  var r = parseInt(document.getElementById('radiusInput').value);
  if(!r || r<=0) return alert("ë°˜ê²½(m)ì„ ì…ë ¥í•˜ì„¸ìš”");

  clickRadiusMode = true;
  clickRadiusBtn.innerText = "ì§€ë„ í´ë¦­ ëŒ€ê¸°ì¤‘...";
}

/* ë°˜ê²½ ê·¸ë¦¬ê¸° ON/OFF */
var drawEnabled=false;
var drawBtn = document.getElementById('drawBtn');

function toggleDraw(){
  drawEnabled=!drawEnabled;
  // ë°˜ê²½ ê·¸ë¦¬ê¸°ê°€ ì¼œì§ˆ ë•Œ ë‹¤ê°í˜• ëª¨ë“œëŠ” ìë™ìœ¼ë¡œ OFF
  if (drawEnabled && polygonModeEnabled){
    polygonModeEnabled = false;
    document.getElementById('polyToggleBtn').innerText = 'ë‹¤ê°í˜• ëª¨ë“œ OFF';
  }
  drawBtn.innerText=drawEnabled?"ë°˜ê²½ ê·¸ë¦¬ê¸° ON":"ë°˜ê²½ ê·¸ë¦¬ê¸° OFF";
}

/* ë§ˆìš°ìŠ¤ë¡œ ë°˜ê²½ ê·¸ë¦¬ê¸° */
var drawingFlag=false, centerPosition;
var drawingLine, drawingCircle;
var circles=[]; // {id, circle, overlay}
var circleIdCounter = 0; // ê³ ìœ  ID ë°œê¸‰ìš©

kakao.maps.event.addListener(map,'click',function(e){

  /* ğŸ”¹ ë°˜ê²½ ì…ë ¥ â†’ í´ë¦­ ìƒì„± */
  if(clickRadiusMode){
    var r = parseInt(document.getElementById('radiusInput').value);
    createCircle(e.latLng, r);

    clickRadiusMode = false;
    clickRadiusBtn.innerText = "ë°˜ê²½ ìƒì„±";
    return;
  }

  /* ğŸ”¹ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ë°˜ê²½ */
  if(!drawEnabled||drawingFlag) return;
  drawingFlag=true;
  centerPosition=e.latLng;

  drawingLine=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
  drawingCircle=new kakao.maps.Circle({
    strokeWeight:3,strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',fillOpacity:0.25
  });
});

kakao.maps.event.addListener(map,'mousemove',function(e){
  if(!drawingFlag) return;
  drawingLine.setPath([centerPosition,e.latLng]);
  var r=drawingLine.getLength();
  if(r>0){
    drawingCircle.setOptions({center:centerPosition,radius:r});
    drawingCircle.setMap(map);
    drawingLine.setMap(map);
  }
});

kakao.maps.event.addListener(map,'rightclick',function(){
  if(!drawingFlag) return;
  createCircle(centerPosition,drawingLine.getLength());
  drawingCircle.setMap(null);
  drawingLine.setMap(null);
  drawingFlag=false;
});

/* ë°˜ê²½ ìƒì„± + ë“œë˜ê·¸ + ê°œë³„ì‚­ì œ (ID ê¸°ë°˜) */
function createCircle(center,radius, id){
  var circle=new kakao.maps.Circle({
    center:center,
    radius:radius,
    strokeWeight:3,
    strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',
    fillOpacity:0.25
  });
  circle.setMap(map);

  // ê³ ìœ  ID ë¶€ì—¬ (ë³µì› ì‹œì—ëŠ” ì „ë‹¬ëœ id ì‚¬ìš©)
  var cid = (typeof id === 'number') ? id : circleIdCounter++;

  // í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ data ì†ì„±ì— id ë¶€ì—¬
  var content = document.createElement('div');
  content.className = 'radius-ui';
  content.setAttribute('data-circle-id', cid);
  content.innerHTML = `${Math.round(radius)}m <button type="button" data-remove-id="${cid}">âœ•</button>`;

  var overlay=new kakao.maps.CustomOverlay({
    position:center,
    content:content,
    yAnchor:1
  });
  overlay.setMap(map);

  enableDrag(circle,overlay,cid,content);
  circles.push({id: cid, circle: circle, overlay: overlay});
}

/* ë“œë˜ê·¸ ì´ë™ (ì› + í…ìŠ¤íŠ¸ ë°•ìŠ¤ ëª¨ë‘ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ) */
function enableDrag(circle,overlay,cid,contentEl){
  // ê³µí†µ ìƒíƒœ
  let isDragging = false;

  // ë“œë˜ê·¸ ì‹œì‘ / ì¢…ë£Œ í—¬í¼
  function startDrag(){
    isDragging = true;
  }
  function endDrag(){
    isDragging = false;
  }

  // ì›ì„ ì§ì ‘ ë“œë˜ê·¸ (ì› í´ë¦­ ë²”ìœ„ê°€ ì¢ì„ ìˆ˜ ìˆì–´ì„œ, ì´ë²¤íŠ¸ë§Œ ìœ ì§€)
  kakao.maps.event.addListener(circle,'mousedown', startDrag);

  // ë§µ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
  kakao.maps.event.addListener(map,'mouseup', endDrag);

  // ìœˆë„ìš° ì–´ë””ì„œë“  ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ (ë§µ ë°–ìœ¼ë¡œ ë‚˜ê°€ë„ ëŠê¹€ ë°©ì§€)
  window.addEventListener('mouseup', endDrag);

  // ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ìœ„ì¹˜ ê°±ì‹ 
  kakao.maps.event.addListener(map,'mousemove', function(e){
    if(!isDragging) return;
    circle.setPosition(e.latLng);
    overlay.setPosition(e.latLng);
  });

  // í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš©
  contentEl.addEventListener('mousedown', function(ev){
    // ì‚­ì œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
    if (ev.target && ev.target.getAttribute('data-remove-id')) return;
    startDrag();
    ev.preventDefault();
  });

  // ì‚­ì œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ë§
  contentEl.addEventListener('click', function(ev){
    var rid = ev.target && ev.target.getAttribute('data-remove-id');
    if (!rid) return;
    handleRemoveOne(parseInt(rid,10));
  });
}

/* ê°œë³„ ì‚­ì œ: IDë¡œ ì°¾ê¸° */
function handleRemoveOne(id){
  var idx = circles.findIndex(c => c.id === id);
  if(idx === -1) return;
  circles[idx].circle.setMap(null);
  circles[idx].overlay.setMap(null);
  circles.splice(idx,1);
}

/* ì „ì²´ ì‚­ì œ */
function removeCircles(){
  circles.forEach(c=>{
    c.circle.setMap(null);
    c.overlay.setMap(null);
  });
  circles=[];
}

// ===== ë‹¤ê°í˜•(ë©´ì ) ê·¸ë¦¬ê¸° ê¸°ëŠ¥ ì¶”ê°€ =====
// ì› ë°˜ê²½ ê¸°ëŠ¥ê³¼ ë³„ë„ë¡œ, ì§€ë„ í´ë¦­ìœ¼ë¡œ ë‹¤ê°í˜•ì„ ê·¸ë¦¬ê³ 
// ìš°í´ë¦­ìœ¼ë¡œ ë©´ì (mÂ²)ì„ í‘œì‹œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

var polygonModeEnabled = false; // ë‹¤ê°í˜• ëª¨ë“œ í† ê¸€ í”Œë˜ê·¸
var drawingPolyFlag = false; // ë‹¤ê°í˜• ê·¸ë¦¬ê¸° ìƒíƒœ
var drawingPolygon;          // ê·¸ë ¤ì§€ê³  ìˆëŠ” ë‹¤ê°í˜•
var polygon;                 // ì™„ì„±ëœ ë‹¤ê°í˜•
var areaOverlay;             // ë©´ì  ì •ë³´ í‘œì‹œìš© ì˜¤ë²„ë ˆì´
var polygonDeleteOverlay;    // ë‹¤ê°í˜• ê°œë³„ ì‚­ì œ ë²„íŠ¼ ì˜¤ë²„ë ˆì´

// ì§€ë„ í´ë¦­: ë‹¤ê°í˜• ê·¸ë¦¬ê¸° ì‹œì‘/ì—°ì¥
kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
  // ê¸°ì¡´ ì› ë°˜ê²½ ë“œë¡œì‰ ì¤‘ì´ë©´ ë‹¤ê°í˜• ë“œë¡œì‰ì€ ì‹œì‘í•˜ì§€ ì•ŠìŒ
  if (drawingFlag || !polygonModeEnabled) return;

  var clickPosition = mouseEvent.latLng;

  if (!drawingPolyFlag) {
    drawingPolyFlag = true;

    // ê¸°ì¡´ ë‹¤ê°í˜• / ë©´ì  í‘œì‹œ ì œê±°
    if (polygon) {
      polygon.setMap(null);
      polygon = null;
    }
    if (areaOverlay) {
      areaOverlay.setMap(null);
      areaOverlay = null;
    }
    if (polygonDeleteOverlay){
      polygonDeleteOverlay.setMap(null);
      polygonDeleteOverlay = null;
    }

    // ê·¸ë ¤ì§€ê³  ìˆëŠ” ë‹¤ê°í˜•
    drawingPolygon = new kakao.maps.Polygon({
      map: map,
      path: [clickPosition],
      strokeWeight: 3,
      strokeColor: '#00a0e9',
      strokeOpacity: 1,
      strokeStyle: 'solid',
      fillColor: '#00a0e9',
      fillOpacity: 0.2
    });

    // ì™„ì„±ëœ ë‹¤ê°í˜•
    polygon = new kakao.maps.Polygon({
      path: [clickPosition],
      strokeWeight: 3,
      strokeColor: '#00a0e9',
      strokeOpacity: 1,
      strokeStyle: 'solid',
      fillColor: '#00a0e9',
      fillOpacity: 0.2
    });

  } else {
    // ì¢Œí‘œ ì¶”ê°€
    var drawingPath = drawingPolygon.getPath();
    drawingPath.push(clickPosition);
    drawingPolygon.setPath(drawingPath);

    var path = polygon.getPath();
    path.push(clickPosition);
    polygon.setPath(path);
  }
});

// ì§€ë„ ë§ˆìš°ìŠ¤ë¬´ë¸Œ: ê·¸ë ¤ì§ˆ ë‹¤ê°í˜•ì˜ ë§ˆì§€ë§‰ ê¼­ì§“ì ì„ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¡œ ë³´ì—¬ì¤Œ
kakao.maps.event.addListener(map, 'mousemove', function (mouseEvent) {
  if (!drawingPolyFlag) return;

  var mousePosition = mouseEvent.latLng;
  var path = drawingPolygon.getPath();

  if (path.length > 1) {
    path.pop();
  }

  path.push(mousePosition);
  drawingPolygon.setPath(path);
});

// ì§€ë„ ìš°í´ë¦­: ë‹¤ê°í˜• ê·¸ë¦¬ê¸° ì¢…ë£Œ + ë©´ì  í‘œì‹œ
kakao.maps.event.addListener(map, 'rightclick', function (mouseEvent) {
  if (!drawingPolyFlag) return;

  if (drawingPolygon) {
    drawingPolygon.setMap(null);
    drawingPolygon = null;
  }

  if (polygon) {
    var path = polygon.getPath();

    if (path.length > 2) {
      polygon.setMap(map);

      var area = Math.round(polygon.getArea());
      var content = '<div class="info">ì´ë©´ì  <span class="number">' + area + '</span> m<sup>2</sup></div>';

      areaOverlay = new kakao.maps.CustomOverlay({
        map: map,
        content: content,
        xAnchor: 0,
        yAnchor: 0,
        position: path[path.length-1]
      });

      // ë‹¤ê°í˜• ê°œë³„ ì‚­ì œ ë²„íŠ¼ ì˜¤ë²„ë ˆì´ ìƒì„± (ì¤‘ì‹¬ ìœ„ì¹˜ì—)
      var bounds = new kakao.maps.LatLngBounds();
      path.forEach(function(p){ bounds.extend(p); });
      var center = bounds.getCenter();
      var delContent = document.createElement('div');
      delContent.className = 'radius-ui';
      delContent.innerHTML = 'ë‹¤ê°í˜• ì‚­ì œ <button type="button">âœ•</button>';

      delContent.addEventListener('click', function(){
        if (polygon){ polygon.setMap(null); polygon = null; }
        if (areaOverlay){ areaOverlay.setMap(null); areaOverlay = null; }
        if (polygonDeleteOverlay){ polygonDeleteOverlay.setMap(null); polygonDeleteOverlay = null; }
      });

      polygonDeleteOverlay = new kakao.maps.CustomOverlay({
        map: map,
        content: delContent,
        position: center,
        yAnchor: 1
      });

    } else {
      polygon = null;
    }
  }

  drawingPolyFlag = false;
});

// ===== ê¸°ëŠ¥ í† ê¸€ í•¨ìˆ˜ë“¤ =====
function togglePolygonMode(){
  polygonModeEnabled = !polygonModeEnabled;

  // ë‹¤ê°í˜• ëª¨ë“œê°€ ì¼œì§€ë©´ ë°˜ê²½ ê·¸ë¦¬ê¸°ëŠ” ìë™ìœ¼ë¡œ OFF
  if (polygonModeEnabled && drawEnabled){
    drawEnabled = false;
    drawBtn.innerText = 'ë°˜ê²½ ê·¸ë¦¬ê¸° OFF';
  }

  var btn = document.getElementById('polyToggleBtn');
  btn.innerText = polygonModeEnabled ? 'ë‹¤ê°í˜• ëª¨ë“œ ON' : 'ë‹¤ê°í˜• ëª¨ë“œ OFF';
}
</script>

</body>
</html>
