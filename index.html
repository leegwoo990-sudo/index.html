<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì¹´ì¹´ì˜¤ë§µ ë°˜ê²½ + ê²€ìƒ‰ + ì €ì¥</title>

<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
.control-box {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
  background: white;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 12px;
}
.control-box input {
  width: 140px;
  margin-bottom: 4px;
}
.control-box button {
  width: 150px;
  margin-top: 4px;
}

.radius-ui {
  background:#fff;
  border:1px solid #ccc;
  border-radius:4px;
  padding:2px 6px;
  font-size:11px;
  white-space:nowrap;
  cursor:move;
}
.radius-ui button {
  border:none;
  background:none;
  cursor:pointer;
  font-size:11px;
  color:#ff3b3b;
  margin-left:4px;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="control-box">
  <input type="text" id="keyword" placeholder="ì¥ì†Œ ê²€ìƒ‰">
  <button onclick="searchPlace()">ê²€ìƒ‰</button>
  <hr>

  <input type="number" id="radiusInput" placeholder="ë°˜ê²½ m ì…ë ¥">
  <button onclick="enableClickRadius()" id="clickRadiusBtn">ë°˜ê²½ ìƒì„±</button>

  <hr>
  <button onclick="toggleDraw()" id="drawBtn">ë°˜ê²½ ê·¸ë¦¬ê¸° OFF</button>
  <button onclick="removeCircles()">ë°˜ê²½ ëª¨ë‘ ì‚­ì œ</button>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac34ac36d4448af73f238be750e1e0e7&libraries=services"></script>

<script>
/* ì§€ë„ */
var map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(37.5665, 126.9780),
  level: 4
});

/* ê²€ìƒ‰ */
var ps = new kakao.maps.services.Places();
var searchMarkers = [];

function searchPlace(){
  var keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert("ê²€ìƒ‰ì–´ ì…ë ¥");

  searchMarkers.forEach(m=>m.setMap(null));
  searchMarkers=[];

  ps.keywordSearch(keyword,function(data,status){
    if(status!==kakao.maps.services.Status.OK) return;
    var bounds=new kakao.maps.LatLngBounds();
    data.forEach(p=>{
      var pos=new kakao.maps.LatLng(p.y,p.x);
      bounds.extend(pos);
      var m=new kakao.maps.Marker({position:pos,map});
      searchMarkers.push(m);
    });
    map.setBounds(bounds);
  });
}

/* ===== ë°˜ê²½ m ì…ë ¥ í›„ í´ë¦­ ìƒì„± ===== */
var clickRadiusMode = false;

function enableClickRadius(){
  var r = parseInt(document.getElementById('radiusInput').value);
  if(!r || r<=0) return alert("ë°˜ê²½(m)ì„ ì…ë ¥í•˜ì„¸ìš”");

  clickRadiusMode = true;
  clickRadiusBtn.innerText = "ì§€ë„ í´ë¦­ ëŒ€ê¸°ì¤‘...";
}

/* ë°˜ê²½ ê·¸ë¦¬ê¸° ON/OFF */
var drawEnabled=false;
function toggleDraw(){
  drawEnabled=!drawEnabled;
  drawBtn.innerText=drawEnabled?"ë°˜ê²½ ê·¸ë¦¬ê¸° ON":"ë°˜ê²½ ê·¸ë¦¬ê¸° OFF";
}

/* ë§ˆìš°ìŠ¤ë¡œ ë°˜ê²½ ê·¸ë¦¬ê¸° */
var drawingFlag=false, centerPosition;
var drawingLine, drawingCircle;
var circles=[];

kakao.maps.event.addListener(map,'click',function(e){

  /* ğŸ”¹ ë°˜ê²½ ì…ë ¥ â†’ í´ë¦­ ìƒì„± */
  if(clickRadiusMode){
    var r = parseInt(document.getElementById('radiusInput').value);
    createCircle(e.latLng, r);
    saveCircles();

    clickRadiusMode = false;
    clickRadiusBtn.innerText = "ë°˜ê²½ ìƒì„±";
    return;
  }

  /* ğŸ”¹ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ë°˜ê²½ */
  if(!drawEnabled||drawingFlag) return;
  drawingFlag=true;
  centerPosition=e.latLng;

  drawingLine=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
  drawingCircle=new kakao.maps.Circle({
    strokeWeight:3,strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',fillOpacity:0.25
  });
});

kakao.maps.event.addListener(map,'mousemove',function(e){
  if(!drawingFlag) return;
  drawingLine.setPath([centerPosition,e.latLng]);
  var r=drawingLine.getLength();
  if(r>0){
    drawingCircle.setOptions({center:centerPosition,radius:r});
    drawingCircle.setMap(map);
    drawingLine.setMap(map);
  }
});

kakao.maps.event.addListener(map,'rightclick',function(){
  if(!drawingFlag) return;
  createCircle(centerPosition,drawingLine.getLength());
  drawingCircle.setMap(null);
  drawingLine.setMap(null);
  drawingFlag=false;
  saveCircles();
});

/* ë°˜ê²½ ìƒì„± + ë“œë˜ê·¸ + ê°œë³„ì‚­ì œ */
function createCircle(center,radius){
  var circle=new kakao.maps.Circle({
    center,radius,
    strokeWeight:3,
    strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',
    fillOpacity:0.25
  });
  circle.setMap(map);

  var idx = circles.length;

  var overlay=new kakao.maps.CustomOverlay({
    position:center,
    content:`<div class="radius-ui">
      ${Math.round(radius)}m
      <button onclick="removeOne(${idx})">âœ•</button>
    </div>`,
    yAnchor:1
  });
  overlay.setMap(map);

  enableDrag(circle,overlay);
  circles.push({circle,overlay});
}

/* ë“œë˜ê·¸ ì´ë™ */
function enableDrag(circle,overlay){
  let dragging=false;

  kakao.maps.event.addListener(circle,'mousedown',()=>dragging=true);
  kakao.maps.event.addListener(map,'mouseup',()=>dragging=false);

  kakao.maps.event.addListener(map,'mousemove',e=>{
    if(!dragging) return;
    circle.setPosition(e.latLng);
    overlay.setPosition(e.latLng);
    saveCircles();
  });
}

/* ê°œë³„ ì‚­ì œ */
function removeOne(idx){
  if(!circles[idx]) return;
  circles[idx].circle.setMap(null);
  circles[idx].overlay.setMap(null);
  circles.splice(idx,1);
  saveCircles();
}

/* ì „ì²´ ì‚­ì œ */
function removeCircles(){
  circles.forEach(c=>{
    c.circle.setMap(null);
    c.overlay.setMap(null);
  });
  circles=[];
  localStorage.removeItem('circles');
}

/* ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° */
function saveCircles(){
  var data=circles.map(c=>({
    lat:c.circle.getPosition().getLat(),
    lng:c.circle.getPosition().getLng(),
    r:c.circle.getRadius()
  }));
  localStorage.setItem('circles',JSON.stringify(data));
}

function loadCircles(){
  var data=JSON.parse(localStorage.getItem('circles')||'[]');
  data.forEach(d=>{
    createCircle(new kakao.maps.LatLng(d.lat,d.lng),d.r);
  });
}
loadCircles();
</script>

</body>
</html>
