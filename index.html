<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì¹´ì¹´ì˜¤ë§µ ë°˜ê²½ + ê²€ìƒ‰ + ì €ì¥ (GitHub Pagesìš©)</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
.control-box {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
  background: white;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 12px;
}
.control-box input {
  width: 140px;
  margin-bottom: 4px;
}
.control-box button {
  width: 150px;
  margin-top: 4px;
}

.radius-ui {
  background:#fff;
  border:1px solid #ccc;
  border-radius:4px;
  padding:4px 8px;
  font-size:11px;
  white-space:nowrap;
  cursor:move; /* ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš© */
  user-select:none;
}
.radius-ui button {
  border:none;
  background:none;
  cursor:pointer;
  font-size:11px;
  color:#ff3b3b;
  margin-left:4px;
}

.info-panel {
  position:absolute;
  right:10px;
  top:10px;
  z-index:20;
}
</style>
</head>

<body class="bg-slate-900">

<div id="map"></div>

<div class="control-box">
  <input type="text" id="keyword" placeholder="ì¥ì†Œ ê²€ìƒ‰">
  <button onclick="searchPlace()">ê²€ìƒ‰</button>
  <hr>

  <input type="number" id="radiusInput" placeholder="ë°˜ê²½ m ì…ë ¥">
  <button onclick="enableClickRadius()" id="clickRadiusBtn">ë°˜ê²½ ìƒì„±</button>

  <hr>
  <button onclick="toggleDraw()" id="drawBtn">ë°˜ê²½ ê·¸ë¦¬ê¸° OFF</button>
  <button onclick="removeCircles()">ë°˜ê²½ ëª¨ë‘ ì‚­ì œ</button>
</div>

<!-- ì˜¤ë¥¸ìª½ ìƒë‹¨: ì €ì¥ ë°©ì‹ ì„¤ëª… -->
<div class="info-panel max-w-xs bg-white/95 text-xs text-slate-800 rounded-lg shadow-lg p-3 hidden md:block">
  <p class="font-semibold mb-1">ì €ì¥ ë°©ì‹ ì•ˆë‚´</p>
  <ul class="list-disc list-inside space-y-1">
    <li>ë°˜ê²½ì„ ë§Œë“¤ê±°ë‚˜ ì´ë™/ì‚­ì œí•˜ë©´ <span class="font-mono">localStorage</span>ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</li>
    <li>ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ ë‹¤ì‹œ ì ‘ì†í•˜ë©´ ì €ì¥ëœ ë°˜ê²½ì´ ìë™ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤.</li>
    <li>"ë°˜ê²½ ëª¨ë‘ ì‚­ì œ" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì €ì¥ëœ ê¸°ë¡ë„ í•¨ê»˜ ì§€ì›Œì§‘ë‹ˆë‹¤.</li>
  </ul>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac34ac36d4448af73f238be750e1e0e7&libraries=services"></script>

<script>
/* ì§€ë„ */
var map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(37.5665, 126.9780),
  level: 4
});

// ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•œë‹¤
var mapTypeControl = new kakao.maps.MapTypeControl();

// ì§€ë„ì˜ ìƒë‹¨ ìš°ì¸¡ì— ì§€ë„ íƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•œë‹¤
map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

/* ê²€ìƒ‰ */
var ps = new kakao.maps.services.Places();
var searchMarkers = [];

function searchPlace(){
  var keyword=document.getElementById('keyword').value.trim();
  if(!keyword) return alert("ê²€ìƒ‰ì–´ ì…ë ¥");

  searchMarkers.forEach(m=>m.setMap(null));
  searchMarkers=[];

  ps.keywordSearch(keyword,function(data,status){
    if(status!==kakao.maps.services.Status.OK) return;
    var bounds=new kakao.maps.LatLngBounds();
    data.forEach(p=>{
      var pos=new kakao.maps.LatLng(p.y,p.x);
      bounds.extend(pos);
      var m=new kakao.maps.Marker({position:pos,map});
      searchMarkers.push(m);
    });
    map.setBounds(bounds);
  });
}

/* ===== ë°˜ê²½ m ì…ë ¥ í›„ í´ë¦­ ìƒì„± ===== */
var clickRadiusMode = false;
var clickRadiusBtn = document.getElementById('clickRadiusBtn');

function enableClickRadius(){
  var r = parseInt(document.getElementById('radiusInput').value);
  if(!r || r<=0) return alert("ë°˜ê²½(m)ì„ ì…ë ¥í•˜ì„¸ìš”");

  clickRadiusMode = true;
  clickRadiusBtn.innerText = "ì§€ë„ í´ë¦­ ëŒ€ê¸°ì¤‘...";
}

/* ë°˜ê²½ ê·¸ë¦¬ê¸° ON/OFF */
var drawEnabled=false;
var drawBtn = document.getElementById('drawBtn');

function toggleDraw(){
  drawEnabled=!drawEnabled;
  drawBtn.innerText=drawEnabled?"ë°˜ê²½ ê·¸ë¦¬ê¸° ON":"ë°˜ê²½ ê·¸ë¦¬ê¸° OFF";
}

/* ë§ˆìš°ìŠ¤ë¡œ ë°˜ê²½ ê·¸ë¦¬ê¸° */
var drawingFlag=false, centerPosition;
var drawingLine, drawingCircle;
var circles=[]; // {id, circle, overlay}
var circleIdCounter = 0; // ê³ ìœ  ID ë°œê¸‰ìš©

kakao.maps.event.addListener(map,'click',function(e){

  /* ğŸ”¹ ë°˜ê²½ ì…ë ¥ â†’ í´ë¦­ ìƒì„± */
  if(clickRadiusMode){
    var r = parseInt(document.getElementById('radiusInput').value);
    createCircle(e.latLng, r);
    saveCircles();

    clickRadiusMode = false;
    clickRadiusBtn.innerText = "ë°˜ê²½ ìƒì„±";
    return;
  }

  /* ğŸ”¹ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ë°˜ê²½ */
  if(!drawEnabled||drawingFlag) return;
  drawingFlag=true;
  centerPosition=e.latLng;

  drawingLine=new kakao.maps.Polyline({strokeWeight:3,strokeColor:'#ff3b3b'});
  drawingCircle=new kakao.maps.Circle({
    strokeWeight:3,strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',fillOpacity:0.25
  });
});

kakao.maps.event.addListener(map,'mousemove',function(e){
  if(!drawingFlag) return;
  drawingLine.setPath([centerPosition,e.latLng]);
  var r=drawingLine.getLength();
  if(r>0){
    drawingCircle.setOptions({center:centerPosition,radius:r});
    drawingCircle.setMap(map);
    drawingLine.setMap(map);
  }
});

kakao.maps.event.addListener(map,'rightclick',function(){
  if(!drawingFlag) return;
  createCircle(centerPosition,drawingLine.getLength());
  drawingCircle.setMap(null);
  drawingLine.setMap(null);
  drawingFlag=false;
  saveCircles();
});

/* ë°˜ê²½ ìƒì„± + ë“œë˜ê·¸ + ê°œë³„ì‚­ì œ (ID ê¸°ë°˜) */
function createCircle(center,radius, id){
  var circle=new kakao.maps.Circle({
    center:center,
    radius:radius,
    strokeWeight:3,
    strokeColor:'#ff3b3b',
    fillColor:'#ff6b6b',
    fillOpacity:0.25
  });
  circle.setMap(map);

  // ê³ ìœ  ID ë¶€ì—¬ (ë³µì› ì‹œì—ëŠ” ì „ë‹¬ëœ id ì‚¬ìš©)
  var cid = (typeof id === 'number') ? id : circleIdCounter++;

  // í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ data ì†ì„±ì— id ë¶€ì—¬
  var content = document.createElement('div');
  content.className = 'radius-ui';
  content.setAttribute('data-circle-id', cid);
  content.innerHTML = `${Math.round(radius)}m <button type="button" data-remove-id="${cid}">âœ•</button>`;

  var overlay=new kakao.maps.CustomOverlay({
    position:center,
    content:content,
    yAnchor:1
  });
  overlay.setMap(map);

  enableDrag(circle,overlay,cid,content);
  circles.push({id: cid, circle: circle, overlay: overlay});
}

/* ë“œë˜ê·¸ ì´ë™ (ì› + í…ìŠ¤íŠ¸ ë°•ìŠ¤ ëª¨ë‘ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ) */
function enableDrag(circle,overlay,cid,contentEl){
  // ê³µí†µ ìƒíƒœ
  let isDragging = false;

  // ë“œë˜ê·¸ ì‹œì‘ / ì¢…ë£Œ í—¬í¼
  function startDrag(){
    isDragging = true;
  }
  function endDrag(){
    isDragging = false;
  }

  // ì›ì„ ì§ì ‘ ë“œë˜ê·¸ (ì› í´ë¦­ ë²”ìœ„ê°€ ì¢ì„ ìˆ˜ ìˆì–´ì„œ, ì´ë²¤íŠ¸ë§Œ ìœ ì§€)
  kakao.maps.event.addListener(circle,'mousedown', startDrag);

  // ë§µ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
  kakao.maps.event.addListener(map,'mouseup', endDrag);

  // ìœˆë„ìš° ì–´ë””ì„œë“  ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ (ë§µ ë°–ìœ¼ë¡œ ë‚˜ê°€ë„ ëŠê¹€ ë°©ì§€)
  window.addEventListener('mouseup', endDrag);

  // ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ìœ„ì¹˜ ê°±ì‹ 
  kakao.maps.event.addListener(map,'mousemove', function(e){
    if(!isDragging) return;
    circle.setPosition(e.latLng);
    overlay.setPosition(e.latLng);
    saveCircles();
  });

  // í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ ì‚¬ìš©
  contentEl.addEventListener('mousedown', function(ev){
    // ì‚­ì œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
    if (ev.target && ev.target.getAttribute('data-remove-id')) return;
    startDrag();
    ev.preventDefault();
  });

  // ì‚­ì œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ë§
  contentEl.addEventListener('click', function(ev){
    var rid = ev.target && ev.target.getAttribute('data-remove-id');
    if (!rid) return;
    handleRemoveOne(parseInt(rid,10));
  });
}

/* ê°œë³„ ì‚­ì œ: IDë¡œ ì°¾ê¸° */
function handleRemoveOne(id){
  var idx = circles.findIndex(c => c.id === id);
  if(idx === -1) return;
  circles[idx].circle.setMap(null);
  circles[idx].overlay.setMap(null);
  circles.splice(idx,1);
  saveCircles();
}

/* ì „ì²´ ì‚­ì œ */
function removeCircles(){
  circles.forEach(c=>{
    c.circle.setMap(null);
    c.overlay.setMap(null);
  });
  circles=[];
  localStorage.removeItem('circles');
}

/* ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° (ë¸Œë¼ìš°ì € localStorage ì‚¬ìš©) */
function saveCircles(){
  var data=circles.map(c=>({
    id: c.id,
    lat:c.circle.getPosition().getLat(),
    lng:c.circle.getPosition().getLng(),
    r:c.circle.getRadius()
  }));
  localStorage.setItem('circles',JSON.stringify(data));
}

function loadCircles(){
  try {
    var raw = localStorage.getItem('circles');
    if(!raw) return;
    var data=JSON.parse(raw);

    // ê¸°ì¡´ ì› ì •ë¦¬
    circles.forEach(c=>{
      c.circle.setMap(null);
      c.overlay.setMap(null);
    });
    circles=[];

    // ì €ì¥ëœ ê°’ìœ¼ë¡œ ë³µì›
    data.forEach(d=>{
      createCircle(new kakao.maps.LatLng(d.lat,d.lng),d.r, d.id);
      if(typeof d.id === 'number' && d.id >= circleIdCounter){
        circleIdCounter = d.id + 1;
      }
    });
  } catch(e){
    console.error('ì €ì¥ëœ ë°˜ê²½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:', e);
  }
}

loadCircles();
</script>

</body>
</html>
